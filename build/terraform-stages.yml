stages:
  - stage: build
    displayName: "package scripts"
    pool:
      vmImage: ubuntu-latest

    jobs:
      - template: terraform-build.yml

  - stage: tf_plan_prd
    displayName: "terraform plan - prod"
    dependsOn: build
    pool:
      vmImage: ubuntu-latest
    variables:
      - name: artifact_name
        value: prd_tfplan
      - name: gateway_name
        value: "azvng-prd-zn-titansoft"
      - name: public_ip_name
        value: "azpip-prd-zn-titansoft"
      - name: resource_group_name
        value: "azrg-prd-zn-vnet"
      - name: tags_environment
        value: "Production"
      - name: virtual_network_name
        value: "azvnet-prd-zn-titansoft"
      - name: workspace_name
        value: "tf-azure-vnet-prd"
    condition: succeeded()

    jobs:
      - template: terraform-plan.yml
        parameters:
          environment: "prod"

  - stage: tf_apply_prd
    displayName: "terraform apply - prod"
    dependsOn: tf_plan_prd
    pool:
      vmImage: ubuntu-latest
    variables:
      - name: artifact_name
        value: prd_tfplan
    condition: succeeded()

    jobs:
      - template: terraform-apply.yml
        parameters:
          environment: "prod"
